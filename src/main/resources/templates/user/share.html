<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>网盘首页</title>
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet" />
    <script th:src="@{/js/jquery-3.5.1.js}"></script>
    <script th:src="@{/layui/layui.js}"></script>
</head>
<body class="layui-layout-body"  >
<div class="layui-layout layui-layout-admin">
    <div th:replace="~{comments/comment.html::topbar}"></div>

    <div th:replace="~{comments/comment.html::sidebar}"></div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div style="padding: 15px;">
            <!--功能按键的抽取-->
            <div th:fragment="function">
                <!--    添加文件-->
                <button type="button" class="layui-btn layui-btn-normal" id="addFile">
                    <i class="layui-icon">&#xe67c;</i>添加文件
                </button>
                <!--    上传文件-->
                <button type="button" class="layui-btn layui-btn-normal" id="upload">
                    <i class="layui-icon">&#xe67c;</i>上传</button>
                <!--    新建文件夹-->
                <button type="button" class="layui-btn layui-btn-primary" id="newFolder"  >
                    新建文件夹
                </button>
                <button type="button" class="layui-btn layui-btn-warm" id="getShareFile" th:onclick="getShareFile()" >
                    保存分享文件
                </button>

                <button type="button" class="layui-btn layui-btn-primary"    th:onclick="backPage()"   th:if="${session.uploadId != 0}">
                    返回上级
                </button>
                <button type="button" class="layui-btn layui-btn-primary " id="" th:onclick="backHome()" th:if="${session.uploadId != 0}" >
                    首页
                </button>
                <!--    查找功能-->
                <form class="form-inline" style="float: right" th:action="@{/user/queryFileName}" method="get">

                    <input class="input-medium search-query" name="fileName" type="text" style="height: 33px;width: 350px">
                    <button type="submit"class="layui-btn layui-btn-sm layui-btn-normal" contenteditable="true">查找</button>
                </form>



                <div class="layui-progress layui-progress-big" lay-showpercent="true" lay-filter="uploadProgressBar"  style="margin-top: 20px;" >
                    <div class="layui-progress-bar layui-bg-blue" lay-percent="0%"></div>
                </div>

                <!--    进度条-->


                <script th:src="@{/layui/layui.js}"></script>


                <style type="text/css">
                    .wrapper {position: relative;}
                    #input {position: absolute;top: 0;left: 0;opacity: 0;z-index: -10;}
                </style>
                <script>
                    // 绑定上传文件功能
                    layui.use(["layer","form", "upload","jquery","element"], function () {
                        // 注意：为了动态显示进度条，必须加载element组件
                        var layer = layui.layer, upload = layui.upload, $ = layui.jquery, element = layui.element;

                        upload.render({
                            accept : "file",
                            elem : "#addFile",
                            auto : false,   //关闭文件自动上传
                            bindAction : "#upload", //文件上传触发按钮
                            url : "/user/upload",

                            progress:function(value){//上传进度回调 value进度值
                                element.progress('uploadProgressBar', value+'%')//设置页面进度条

                            },
                            before : function (obj) {
                                // this.data={'uri':window.location.href};//关键代码

                            },
                            done : function (res, index, upload) {
                                if(res.code != 200){
                                    layer.open({
                                        icon : 2,
                                        skin : "layui-layer-molv",
                                        content : res.msg
                                    });
                                }else
                                {
                                    window.location.reload();
                                }
                            },
                            error : function (res) {

                            }
                        });


                    });

                    // 绑定新建文件夹按钮
                    layui.use('layer', function() { //独立版的layer无需执行这一句
                        var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
                        $('#newFolder').on('click', function(){
                            layer.open({
                                id:1,
                                type: 1,
                                title:'新建文件夹',
                                skin:'layui-layer-rim',
                                area:['300px', '220px'],

                                content: ' <div class="row" style="width: 200px;  margin-left:60px; margin-top:40px;">'
                                    +'<div class="col-sm-12">'
                                    +'<div class="input-group">'
                                    +'<span class="input-group-addon icon-align-centers"  > 文件夹名  :</span>'
                                    +'<input id="fileName" type="text" class="form-control" placeholder="">'
                                    +'</div>'
                                    +'</div>'
                                    +'</div>'
                                ,

                                btn:['保存','取消'],
                                btn1: function (index,layro) {
                                    var fileName=$('#fileName').val();
                                    $.ajax({
                                        type : "POST",
                                        url :"/user/newFolder",
                                        dataType:"json",
                                        async: false,
                                        data:{
                                            "fileName":fileName
                                        },
                                        success: function(data) {
                                            if (data.code == 200) {

                                                alert(200);
                                            }
                                        }

                                    });


                                    layer.close(index);
                                    window.location.reload();


                                    // parent.location.reload();
                                },
                                btn2:function (index,layero) {
                                    layer.close(index);
                                }

                            });
                        });
                    });

                    // 返回按钮
                    function backPage() {
                        window.location.href="/user/share/backPage";
                    }
                    // 返回首页按钮
                    function backHome() {
                        window.location.href="/user/share";
                    }
                    function getShareFile() {
                        window.location.href="/user/share/getShareFile";
                    }

                </script>



            </div>

            <!--文件列表的展示-->
            <div th:fragment="list">
                <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                    <legend>全部文件</legend>
                </fieldset>
                <table class="layui-table" lay-skin="line">
                    <colgroup>
                        <!--            <col width="500">-->
                        <!--            <col width="300">-->
                        <!--            <col width="300">-->
                        <col width="450">
                        <col width="300">
                        <col width="300">
                        <col>
                    </colgroup>
                    <thead>
                    <tr>
                        <th>文件名</th>
                        <th>文件大小</th>
                        <th>修改时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="userFolder:${userFolders}">
                        <!--            parentId就是这个文件夹的当前id-->
                        <td><a  th:href="@{/user/share/{parentId}/(parentId=${userFolder.getFolderId()})} " th:text="${userFolder.getFolderName()} "></a></td>
                        <td>-</td>
                        <td th:text="${#dates.format(userFolder.getModifyTime())}"></td>
                        <td>
                            <a th:href="@{/user/share/{parentId}/(parentId=${userFolder.getFolderId()})} "><button type="button" class="layui-btn   layui-btn-radius layui-btn-primary"  >进入</button></a>
                            <a  th:href="@{/user/deleteFolder/{folderId}/(folderId=${userFolder.getFolderId()})} " onclick="if(confirm('确定删除这个文件夹吗？【7天内可以在回收站内找回】')==false)return false;"><button type="button" class="layui-btn layui-btn-danger layui-btn-radius">删除</button></a>

                        </td>
                    </tr>

                    <tr th:each="userFile:${userFiles}">
                        <td><a th:text="${userFile.getFileName()} "  th:href="@{/user/download/{originId}/(originId=${userFile.getOriginId()})}"></a></td>
                        <!--                    <td th:text="${fileSize.get(userFile.getFileId())}"></td>-->
                        <td th:text="${fileSize.get(userFile.getFileId())}">
                        <td th:text="${#dates.format(userFile.getModifyTime())}"></td>
                        <td>
                            <a th:href="@{/user/download/{originId}/(originId=${userFile.getOriginId()})}"> <button type="button" class="layui-btn layui-btn-normal layui-btn-radius"  >下载</button></a>

                            <a  th:href="@{/user/deleteFile/{fileId}/(fileId=${userFile.getFileId()})}" onclick="if(confirm('确定删除这个文件吗？【7天内可以在回收站内找回】')==false)return false;"><button type="button" class="layui-btn layui-btn-danger layui-btn-radius">删除</button></a>
                            <button type="button" class="layui-btn   layui-btn-warm layui-btn-radius" onclick="shareFile(this)" th:value="${userFile.getFileId()}" >分享</button>


                        </td>
                    </tr>
                    <textarea id="input" >别删，这个是为了实现复制粘贴的标签</textarea>
                    </tbody>
                </table>

                <style type="text/css">
                    .wrapper {position: relative;}
                    #input {position: absolute;top: 0;left: 0;opacity: 0;z-index: -10;}
                </style>
                <script type="text/javascript">
                    function shareFile(obj) {
                        var fileID=$(obj).val();
                        // 网盘部署上
                        var url = "xmzsp.cn/user/shareFile/"+fileID ;
                        // var url = "http://localhost:8080/user/shareFile/"+fileID ;
                        var input = document.getElementById("input");
                        console.log(url);
                        input.value = url; // 修改文本框的内容
                        console.log(input.value);
                        input.select(); // 选中文本
                        document.execCommand("copy"); // 执行浏览器复制命令
                        alert("复制分享链接成功！快去分享给好友把");
                    }
                </script>
            </div>
        </div>

        <div th:replace="~{comments/comment.html::footbar}"></div>
    </div>




</div>
</body>

</html>
